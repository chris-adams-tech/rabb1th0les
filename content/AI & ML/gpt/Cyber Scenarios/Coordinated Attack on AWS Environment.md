---
Owner: Chris Adams
title: Coordinated Attack on AWS Environment
date: 2024-11-13
edited: 
layout: new_page
tags:
  - ai-generated
draft: false
Summary: Involving Privilege Escalation and Data Exfiltration
---
> [!Important] Important!
> This is a fake scenario generated by AI and is meant solely for educational purposes. 
### **Scenario: Coordinated Attack on AWS Environment Involving Privilege Escalation and Data Exfiltration**

#### **Background:**
It’s Wednesday afternoon, and your SOC dashboard is lighting up with alerts from multiple sources in your AWS environment. These alerts involve suspicious IAM activity, unusual network traffic, and potential data exfiltration attempts from S3. The alerts suggest that an attacker has potentially escalated privileges and is attempting to extract sensitive data from the environment.

Your task is to correlate these alerts, trace the attacker’s movements through the environment, and take immediate actions to mitigate further impact.

<div class="neon-line"></div>

#### **Alert Summary and Log Sources:**

1. **Unauthorized IAM Policy Modification (CloudTrail)**  
   Type: CloudTrail Alert  
   Source: `UserAccount123`  
   Description: The IAM user `UserAccount123` was modified to include administrator-level privileges (`AdministratorAccess` policy), despite not requiring elevated permissions. This alert originated from a CloudTrail event.

2. **Port Scanning Activity Detected (GuardDuty)**  
   Type: GuardDuty Alert  
   Source: IP 198.51.100.24 (Unfamiliar external IP)  
   Description: GuardDuty detected port scanning activity from an external IP (198.51.100.24) targeting multiple EC2 instances within a VPC, likely probing for open services.

3. **Unusual Data Transfer Patterns (VPC Flow Logs)**  
   Type: Network Behavior Anomaly Alert  
   Source: Multiple S3 buckets (`s3://customer-data`, `s3://confidential-reports`)  
   Description: High volume of outbound data transfers to IP addresses outside the usual range of trusted networks was detected in the VPC Flow Logs, originating from instances accessing these S3 buckets.

4. **Unauthorized SSH Key Pair Creation (AWS Config)**  
   Type: AWS Config Alert  
   Source: `UserAccount123`  
   Description: AWS Config flagged the creation of a new SSH key pair by `UserAccount123`. This action deviates from the organization’s security policy, which prohibits SSH key pair creation without prior approval.

<div class="neon-line"></div>

### **Objective:**
Correlate the logs across CloudTrail, GuardDuty, VPC Flow Logs, and AWS Config to uncover the full scope of the attack. Determine the attacker’s methods, their objectives, and identify steps to contain and remediate the compromise.

<div class="neon-line"></div>

### **Fake Telemetry Details and Logs**

#### **Alert 1: Unauthorized IAM Policy Modification (CloudTrail)**

**Telemetry Data (CloudTrail Logs):**
- **Source Account**: `UserAccount123`
- **Policy Modified**: `AdministratorAccess` added to `UserAccount123`
- **Event Timeline**:
  - **12:00 PM** - `UserAccount123` policy changed to include `AdministratorAccess`.
  - **12:05 PM** - `UserAccount123` initiated a `DescribeInstances` API call, listing all EC2 instances.
  - **12:10 PM** - `UserAccount123` performed a `GetBucketAcl` and `ListBucket` on multiple S3 buckets.

**Analysis:**  
The addition of `AdministratorAccess` privileges to `UserAccount123` suggests unauthorized privilege escalation. The subsequent calls to `DescribeInstances` and `ListBucket` indicate reconnaissance, potentially to identify valuable targets for further exploitation.

<div class="neon-line"></div>

#### **Alert 2: Port Scanning Activity Detected (GuardDuty)**

**Telemetry Data (GuardDuty Findings):**
- **Source IP**: 198.51.100.24 (Unfamiliar external IP)
- **Target Instances**: `EC2-Web-01`, `EC2-DB-02`
- **Ports Scanned**: 22 (SSH), 80 (HTTP), 443 (HTTPS)
- **Event Timeline**:
  - **1:00 PM** - Port scan detected against `EC2-Web-01` and `EC2-DB-02` over SSH, HTTP, and HTTPS ports.
  - **1:05 PM** - Additional attempts on `EC2-App-03` over multiple common service ports.

**Analysis:**  
The port-scanning activity suggests the attacker may be probing for accessible services on these EC2 instances, possibly intending to exploit them directly or establish a reverse shell if vulnerabilities are present.

<div class="neon-line"></div>

#### **Alert 3: Unusual Data Transfer Patterns (VPC Flow Logs)**

**Telemetry Data (VPC Flow Logs):**
- **Source Instances**: `EC2-App-03`, `EC2-Web-01`
- **Destination IPs**: 203.0.113.60 (untrusted external IP), 203.0.113.61
- **Transferred Buckets**: `s3://customer-data`, `s3://confidential-reports`
- **Event Timeline**:
  - **1:30 PM** - Large outbound data transfer from `EC2-App-03` to external IPs 203.0.113.60 and 203.0.113.61.
  - **1:35 PM** - Data transfer detected from `s3://customer-data` and `s3://confidential-reports` through `EC2-Web-01`.

**Analysis:**  
Outbound data transfer from these S3 buckets, especially to untrusted IPs, strongly suggests data exfiltration. The attacker appears to be using compromised EC2 instances to stage and transfer sensitive data from S3 to external destinations.

<div class="neon-line"></div>

#### **Alert 4: Unauthorized SSH Key Pair Creation (AWS Config)**

**Telemetry Data (AWS Config Logs):**
- **Source Account**: `UserAccount123`
- **SSH Key Created**: `KeyPair-UnauthorizedAccess`
- **Event Timeline**:
  - **12:15 PM** - `UserAccount123` created a new SSH key pair (`KeyPair-UnauthorizedAccess`), likely with the intent of establishing persistent access.

**Analysis:**  
Creating an SSH key pair without approval indicates an attempt at persistence. The attacker likely intends to use this key pair to maintain remote access to one or more EC2 instances without relying on compromised credentials alone.

<div class="neon-line"></div>

### **Investigation Steps**

Here’s a step-by-step approach to correlate the events across different logs and gain a comprehensive understanding of the attack.

#### **Step 1: Investigate the IAM Privilege Escalation**

- **Analyze CloudTrail Logs**:
  - Confirm if `UserAccount123` has a history of administrative privilege changes.
  - Identify the source of the `AdministratorAccess` privilege modification and see if this action aligns with any recent key or session creation events, possibly indicating stolen or misused credentials.
  
- **Trace API Activity After Privilege Escalation**:
  - Identify which services `UserAccount123` accessed after obtaining admin privileges (e.g., `DescribeInstances`, `ListBucket`) to locate the primary targets of the attack.

#### **Step 2: Examine Port Scanning Patterns**

- **Correlate GuardDuty and VPC Flow Logs**:
  - Review GuardDuty’s port scan findings and correlate them with VPC Flow Logs to verify if connections were successful on critical ports (e.g., SSH on port 22).
  - Investigate if any response traffic left the VPC, indicating a potential connection established between the attacker and an EC2 instance.

- **Analyze Targeted Instances**:
  - Focus on `EC2-Web-01` and `EC2-DB-02`, checking for unusual processes or configurations that could indicate compromise (e.g., unauthorized software or reverse shells).

#### **Step 3: Confirm Data Exfiltration from S3 Buckets**

- **Examine VPC Flow Logs for Outbound Traffic**:
  - Review logs for any large data transfers from the S3 buckets (`customer-data`, `confidential-reports`) to external IPs. Calculate approximate data volumes to gauge the extent of exfiltration.
  
- **Review S3 Access Patterns (CloudTrail)**:
  - Cross-reference S3 access logs with CloudTrail events to confirm if `UserAccount123` or other compromised accounts accessed these buckets for `GetObject` or `ListBucket` actions.

#### **Step 4: Investigate the SSH Key Pair Creation**

- **Check AWS Config Logs for Persistent Access Indicators**:
  - Review AWS Config logs to verify if `KeyPair-UnauthorizedAccess` was associated with any EC2 instances, specifically `EC2-App-03` and `EC2-Web-01`.
  
- **Trace SSH Login Events**:
  - If possible, check login events on the affected instances (`EC2-App-03`, `EC2-Web-01`) to see if the unauthorized key pair was used for access.

#### **Step 5: Correlate Events for Full Attack Path**

- **Establish Attack Timeline**:
  - Start with the IAM privilege escalation, then track the attacker’s movements across S3 access, port scanning, and EC2 creation and activity. Identify if the port scanning was an attempt to identify open resources for data staging or persistence.

<div class="neon-line"></div>

### **Containment and Remediation Actions**

1. **Immediate Actions:**
   - **Revoke `UserAccount123`’s Access**: Disable the account to prevent further abuse of escalated privileges.
   - **Delete Unauthorized SSH Key Pair**: Remove `KeyPair-UnauthorizedAccess` from affected EC2 instances to cut off persistent SSH access.
   - **Terminate Malicious EC2 Instances**: Shut down instances involved in the data exfiltration (`EC2-App-03`, `EC2-Web-01`) and assess their AMI configurations to identify any back doors.

2. **Remediation:**
   - **Rotate All IAM Keys and Passwords** for potentially compromised accounts and audit MFA compliance.
   - **Review and Harden S3 Bucket Permissions**: Ensure buckets have restricted access and monitor for future unauthorized access patterns.
   - **Conduct Post-Incident Forensics**: Review all other IAM accounts for unauthorized policy changes, access keys, and create alerts for high-privilege policy modifications.

3. **Long-Term Security Improvements:**
   - **Enable GuardDuty and VPC Flow Logging** across additional VPCs to improve network traffic visibility.
   - **Implement Stronger IAM Policies**: Apply the principle of least privilege rigorously to IAM users to limit unauthorized privilege escalation potential.
   - **Deploy S3 Access Monitoring Solutions**: Use Amazon Macie or CloudTrail with tighter alert thresholds for detecting large-volume data transfers from S3 buckets.

<div class="neon-line"></div>

This scenario incorporates multiple AWS log sources, giving a realistic view of how various telemetry sources work together to track complex, multi-step attacks in a cloud environment.

<div class="neon-line"></div>

Thanks for taking the time to read through my content. If you enjoy this type of content, check back here for more updates. 

Peace ✌️

#### Created on: Nov 12, 2024
---

<div style="text-align: center;">
	<div class="gradient-text">👾 2024 rabb1th0les (Chris A)dams 👾</div> 
	🌴☀Thanks for supporting my page ☀🌴
	<nav>
		<ul style="list-style: none; padding: 0;">
			<div style="text-align: center;">
				<li><a href="Contact.html">Contact</a></li>
			</div>
		</ul>
	</nav>	
</div>